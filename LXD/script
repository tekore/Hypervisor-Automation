#!/bin/bash

set -e

# === Variables ===
CONTAINER_NAME="github-runner-$RANDOM"
USER="runner"
PASSWORD="Changeme123"
SSH_KEY_PATH="/root/.ssh/id_rsa.pub"
ANSIBLE_REPO_URL="https://github.com/tekore/Ansible.git"
ANSIBLE_REPO_PLAYBOOK="playbooks/configure-runner.yml"
GITHUB_REPO_URL="https://github.com/tekore/HomeOps"
GITHUB_RUNNER_NAME="LXD-Runner"
GITHUB_PAT="github_pat_124325431DFRGDRLKMNNiissNOTREAL"
CLOUDFLARE_TUNNEL_TOKEN="eyWFFWJhFJWJWJBAUVUUOIjNOTREAL"

# === Create cloud-init configuration ===
CLOUD_INIT_CONFIG=$(cat <<EOF
#cloud-config
write_files:
  - path: /tmp/runner_secrets.yml
    content: |
        ---
        # GitHub Runner Secrets
        github_repo_url: $GITHUB_REPO_URL
        github_runner_name: $GITHUB_RUNNER_NAME
        github_pat: $GITHUB_PAT
        cloudflare_tunnel_token: $CLOUDFLARE_TUNNEL_TOKEN
    owner: 'root:root'
    permissions: '0644'
ssh_pwauth: true
disable_root: false
chpasswd:
  list: |
    $USER:$PASSWORD
  expire: false
users:
  - name: $USER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    lock_passwd: false
runcmd:
  - sleep 10
  - apt-get update
  - apt-get upgrade -y
  - apt-get install -y ansible openssh-server
  - ansible-pull -U $ANSIBLE_REPO_URL -i localhost --purge $ANSIBLE_REPO_PLAYBOOK --extra-vars "@/tmp/runner_secrets.yml"
EOF
)

# === Print cloud-init file for debugging purposes ===
echo "=== Cloud-init Configuration ==="
echo "$CLOUD_INIT_CONFIG"
echo "==============================="

# === Initialize LXD if not already done ===
if ! lxd version &>/dev/null; then
    echo "LXD not found. Please install LXD first."
    exit 1
fi

# === Launch the container ===
echo "Launching Ubuntu 22.04 container..."
lxc launch ubuntu:22.04 $CONTAINER_NAME \
    --config limits.memory=4GB \
    --config boot.autostart=true

echo "✅ Container $CONTAINER_NAME created"

# === Wait for container to be ready ===
echo "Waiting for container to be ready..."
sleep 10
lxc exec $CONTAINER_NAME -- cloud-init status --wait || true

# === Apply cloud-init configuration ===
echo "Applying cloud-init configuration..."
echo "$CLOUD_INIT_CONFIG" | lxc exec $CONTAINER_NAME -- tee /var/lib/cloud/seed/nocloud-net/user-data
lxc exec $CONTAINER_NAME -- cloud-init clean
lxc restart $CONTAINER_NAME

echo "Waiting for cloud-init to complete..."
sleep 15
lxc exec $CONTAINER_NAME -- cloud-init status --wait

# === Add SSH key if provided ===
if [ -f "$SSH_KEY_PATH" ]; then
    echo "Adding SSH key..."
    SSH_KEY=$(cat "$SSH_KEY_PATH")
    lxc exec $CONTAINER_NAME -- sudo -u $USER mkdir -p /home/$USER/.ssh
    lxc exec $CONTAINER_NAME -- sudo -u $USER sh -c "echo '$SSH_KEY' >> /home/$USER/.ssh/authorized_keys"
    lxc exec $CONTAINER_NAME -- sudo -u $USER chmod 700 /home/$USER/.ssh
    lxc exec $CONTAINER_NAME -- sudo -u $USER chmod 600 /home/$USER/.ssh/authorized_keys
    echo "✅ SSH key added"
fi

# === Get container IP ===
echo "Getting container IP address..."
sleep 5
CONTAINER_IP=$(lxc list $CONTAINER_NAME -c 4 --format csv | cut -d' ' -f1)

echo "==============================="
echo "✅ Container $CONTAINER_NAME created and configured"
echo "Container IP: $CONTAINER_IP"
echo "Username: $USER"
echo "Password: $PASSWORD"
echo "==============================="